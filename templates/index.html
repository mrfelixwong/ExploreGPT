{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>AI Chat - {{ settings.ui_settings.selected_provider|title }}</h2>
    
    <!-- Conversation History -->
    {% if conversation %}
    <div class="conversation-history" style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 6px;">
        {% for turn in conversation %}
            <div class="conversation-turn" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                <div class="user-message" style="margin-bottom: 0.5rem;">
                    <strong>You:</strong> {{ turn.user_message }}
                </div>
                <div class="ai-response">
                    <strong>{{ turn.response.provider|title if turn.response.provider else "AI" }}:</strong> 
                    {{ turn.response.response }}
                    {% if settings.response_settings.show_metadata and turn.response.latency %}
                        <small style="color: #666;">({{ turn.response.latency }}ms)</small>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; font-style: italic; margin-bottom: 1rem;">Start a new conversation below...</p>
    {% endif %}
    
    <!-- Message Input Form -->
    <form id="chat-form" style="border-top: 1px solid #eee; padding-top: 1rem;">
        <div class="form-group">
            <textarea name="message" id="message" rows="3" placeholder="Type your message here..." required style="resize: vertical;"></textarea>
        </div>
        
        <button type="submit" id="send-btn" class="btn">Send Message</button>
        {% if conversation %}
            <a href="/new-chat" class="btn btn-secondary" style="margin-left: 0.5rem;">New Chat</a>
        {% endif %}
    </form>
    
    <!-- Search indicator (hidden by default) -->
    <div id="search-indicator" style="display: none; margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
        <div id="search-message">üîç Searching the web...</div>
    </div>
    
    <!-- Search results (hidden by default) -->
    <div id="search-results" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
        <div id="search-results-header" style="font-weight: bold; margin-bottom: 0.5rem;">üì∞ Search Results</div>
        <div id="search-results-list"></div>
        <div id="search-toggle" style="margin-top: 0.5rem;">
            <button type="button" onclick="toggleSearchResults()" style="background: none; border: none; color: #007bff; cursor: pointer; font-size: 0.9em;">Show Details</button>
        </div>
    </div>
    
    <!-- Typing indicator (hidden by default) -->
    <div id="typing-indicator" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 6px; font-style: italic;">
        <div class="typing-animation">
            <span>AI is thinking</span>
            <span class="dots">
                <span>.</span>
                <span>.</span>
                <span>.</span>
            </span>
        </div>
    </div>
    
    <!-- Streaming response area -->
    <div id="streaming-response" style="display: none; margin-top: 1rem; padding: 1rem; background: #fafafa; border-radius: 6px; border-left: 4px solid #2563eb;">
        <div id="streaming-content" style="white-space: pre-wrap;"></div>
        <div id="streaming-meta" style="font-size: 0.8em; color: #666; margin-top: 0.5rem;"></div>
    </div>
    
    <script>
    let streamingContent = '';
    
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const messageInput = document.getElementById('message');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Disable form and show loading state
        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        messageInput.disabled = true;
        
        // Reset all indicators
        document.getElementById('search-indicator').style.display = 'none';
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('typing-indicator').style.display = 'none';
        document.getElementById('streaming-response').style.display = 'none';
        streamingContent = '';
        
        // Start streaming
        fetch('/stream-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                return reader.read().then(({ done, value }) => {
                    if (done) {
                        return;
                    }
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamData(data);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                            }
                        }
                    }
                    
                    return readStream();
                });
            }
            
            return readStream();
        })
        .catch(error => {
            console.error('Streaming error:', error);
            handleError('Connection error. Please try again.');
        });
        
        function handleStreamData(data) {
            if (data.type === 'searching') {
                // Show search indicator
                document.getElementById('search-indicator').style.display = 'block';
                document.getElementById('search-message').textContent = data.message;
                
            } else if (data.type === 'search_complete') {
                // Show search results
                document.getElementById('search-indicator').style.display = 'none';
                document.getElementById('search-results').style.display = 'block';
                document.getElementById('search-results-header').textContent = data.message;
                
                // Display search results
                if (data.results && data.results.length > 0) {
                    let resultsHtml = '<div style="font-size: 0.9em;">';
                    data.results.forEach((result, index) => {
                        resultsHtml += `
                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                                <strong>${result.title}</strong><br>
                                <a href="${result.url}" target="_blank" style="color: #007bff; font-size: 0.8em;">${result.url}</a><br>
                                <span style="color: #666; font-size: 0.8em;">${result.snippet}</span>
                            </div>
                        `;
                    });
                    resultsHtml += '</div>';
                    document.getElementById('search-results-list').innerHTML = resultsHtml;
                } else {
                    document.getElementById('search-results-list').innerHTML = '<em>No detailed results available</em>';
                }
                
            } else if (data.type === 'typing') {
                // Keep typing indicator
                document.getElementById('typing-indicator').style.display = 'block';
                
            } else if (data.type === 'start') {
                // Hide typing, show streaming response
                document.getElementById('typing-indicator').style.display = 'none';
                document.getElementById('streaming-response').style.display = 'block';
                document.getElementById('streaming-meta').textContent = 
                    'Provider: ' + (data.provider || '') + ' | Model: ' + (data.model || '');
                streamingContent = '';
                
            } else if (data.type === 'content') {
                // Append streaming content
                streamingContent += data.text;
                document.getElementById('streaming-content').textContent = streamingContent;
                
            } else if (data.type === 'end') {
                // Show completion metadata
                document.getElementById('streaming-meta').textContent += 
                    ' | Latency: ' + data.latency + 'ms';
                
            } else if (data.type === 'complete') {
                // Response complete, reload page to show in conversation history
                messageInput.value = '';
                window.location.reload();
                
            } else if (data.type === 'error') {
                // Handle error
                handleError('Error: ' + data.message);
            }
        }
        
        function handleError(message) {
            document.getElementById('streaming-content').textContent = message;
            document.getElementById('search-indicator').style.display = 'none';
            document.getElementById('typing-indicator').style.display = 'none';
            
            // Re-enable form
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send Message';
            messageInput.disabled = false;
        }
    });
    
    // Toggle search results details
    function toggleSearchResults() {
        const resultsList = document.getElementById('search-results-list');
        const toggleBtn = document.querySelector('#search-toggle button');
        
        if (resultsList.style.display === 'none') {
            resultsList.style.display = 'block';
            toggleBtn.textContent = 'Hide Details';
        } else {
            resultsList.style.display = 'none';
            toggleBtn.textContent = 'Show Details';
        }
    }
    
    // Initially hide search results details
    document.addEventListener('DOMContentLoaded', function() {
        const resultsList = document.getElementById('search-results-list');
        if (resultsList) {
            resultsList.style.display = 'none';
        }
    });
    </script>
</div>

<div class="card">
    <h3>Current Configuration</h3>
    <div class="grid">
        <div>
            <h4>Selected Provider:</h4>
            <p>{{ settings.ui_settings.selected_provider|title }}</p>
            <p><em>Change in Settings to use a different AI provider</em></p>
        </div>
        
        <div>
            <h4>Settings Summary:</h4>
            <ul>
                <li>Max Tokens: {{ settings.response_settings.max_tokens }}</li>
                <li>Temperature: {{ settings.response_settings.temperature }}</li>
                <li>Cost Tracking: {{ "Yes" if settings.cost_management.track_costs else "No" }}</li>
                <li>Memory: Simple conversation context</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h3>Features</h3>
    <ul>
        <li><strong>Provider Selection:</strong> Choose your preferred AI provider in Settings</li>
        <li><strong>Smart Memory:</strong> The system learns from your conversations (if enabled)</li>
        <li><strong>Cost Tracking:</strong> Monitor API usage costs in real-time</li>
        <li><strong>Customizable:</strong> Adjust models, settings, and preferences</li>
    </ul>
</div>
{% endblock %}